option_settings:
  aws:elasticbeanstalk:application:environment:
    ES_JAVA_OPTS: -Xms6g -Xmx6g

files:
  "/usr/lib/jvm/jre-1.8.0-openjdk.x86_64/lib/security/java.policy":
    mode: "644"
    owner: root
    group: root
    content: |
      grant codeBase "file:${{java.ext.dirs}}/*" {
              permission java.security.AllPermission;
      };

      grant {
              permission java.lang.RuntimePermission "stopThread";
              permission java.lang.RuntimePermission "accessDeclaredMembers";
              permission java.lang.RuntimePermission "getClassLoader";
              permission javax.management.MBeanTrustPermission "register";
              permission javax.management.MBeanTrustPermission "findMBeanServer";
              permission java.net.SocketPermission "localhost:0", "listen";
              permission java.util.PropertyPermission "java.version", "read";
              permission java.util.PropertyPermission "java.vendor", "read";
              permission java.util.PropertyPermission "java.vendor.url", "read";
              permission java.util.PropertyPermission "java.class.version", "read";
              permission java.util.PropertyPermission "os.name", "read";
              permission java.util.PropertyPermission "os.version", "read";
              permission java.util.PropertyPermission "os.arch", "read";
              permission java.util.PropertyPermission "file.separator", "read";
              permission java.util.PropertyPermission "path.separator", "read";
              permission java.util.PropertyPermission "line.separator", "read";
              permission java.util.PropertyPermission "java.specification.version", "read";
              permission java.util.PropertyPermission "java.specification.vendor", "read";
              permission java.util.PropertyPermission "java.specification.name", "read";
              permission java.util.PropertyPermission "java.vm.specification.version", "read";
              permission java.util.PropertyPermission "java.vm.specification.vendor", "read";
              permission java.util.PropertyPermission "java.vm.specification.name", "read";
              permission java.util.PropertyPermission "java.vm.version", "read";
              permission java.util.PropertyPermission "java.vm.vendor", "read";
              permission java.util.PropertyPermission "java.vm.name", "read";
      };

  "/opt/elasticbeanstalk/hooks/appdeploy/pre/00_setup_elasticsearch.sh":
    mode: "744"
    owner: root
    group: root
    content: |
      #!/bin/bash
      INSTALL=false
      ES_VER=5.6.11
      SCRIPT_ABS_FILE=$(readlink -f $0)
      CURRENT_MD5=$(md5sum "$SCRIPT_ABS_FILE" | cut -d ' ' -f 1)
      STORED_MD5=$(cat ~/.esconfigversion)

      if [ ! -f ~/.esconfigversion ]; then
        echo "~/.esconfigversion not found, building again."
        INSTALL=true
      fi

      if [ "$INSTALL" != true ] && [ "$CURRENT_MD5" != "$STORED_MD5" ]; then
        echo "Script is modified, building again."
        INSTALL=true
      fi

      if [ "$INSTALL" = true ]; then
        ES_URL=https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-$ES_VER.zip
        cd ~/ && wget $ES_URL
        unzip elasticsearch-*

        rm -rf /usr/local/elasticsearch-*
        mv elasticsearch-* /usr/local/

        mkdir -p /etc/elasticsearch/plugins
        mkdir -p /var/esdata

        /usr/local/elasticsearch-$ES_VER/bin/elasticsearch-plugin install discovery-ec2
        /usr/local/elasticsearch-$ES_VER/bin/elasticsearch-plugin install repository-s3

        test -f /opt/aws/bin/elasticsearch && unlink /opt/aws/bin/elasticsearch
        ln -s /usr/local/elasticsearch-$ES_VER/bin/elasticsearch /opt/aws/bin

        chown -R webapp:webapp /var/esdata

        echo $CURRENT_MD5 > ~/.esconfigversion

        sysctl -w vm.max_map_count=262144

        echo "Done!"
      else
        echo "Script is not updated since last install, not running again."
      fi

  "/opt/elasticbeanstalk/hooks/appdeploy/pre/01_setup_telegraf.sh":
    mode: "744"
    owner: root
    group: root
    content: |
      #!/bin/bash
      mkdir -p /tmp/setup_telegraf
      cd /tmp/setup_telegraf
      wget https://s3.amazonaws.com/devex-setup-info/dist/tools/setup_telegraf.sh
      chmod +x setup_telegraf.sh
      ./setup_telegraf.sh

container_commands:
        01_run_setup_script:
            command: "/opt/elasticbeanstalk/hooks/appdeploy/pre/00_setup_elasticsearch.sh"
